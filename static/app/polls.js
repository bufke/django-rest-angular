// Generated by CoffeeScript 1.7.1
(function() {
  var app;

  app = angular.module('angular_django', ['restangular', 'ngRoute']);

  app.controller('PollController', [
    '$scope', '$routeParams', '$route', 'RestfulModel', function($scope, $routeParams, $route, RestfulModel) {
      return $scope.$on('$routeChangeSuccess', function() {
        var pollModel;
        pollModel = new RestfulModel.Instance("polls");
        $scope.polls = pollModel.getList();
        pollModel.getOptions().then(function(options) {
          return $scope.pollOptions = options;
        });
        return pollModel.getOne($routeParams.poll_id, $scope.form).then(function(poll) {
          $scope.poll = poll;
          return $scope.savePoll = poll.saveForm;
        });
      });
    }
  ]);

  app.factory('RestfulModel', [
    'Restangular', function(Restangular) {
      var Instance;
      Instance = function(name) {
        this.modelName = name;
        this.getOptions = function() {
          return Restangular.all(this.modelName).options().then(function(options) {
            return options.actions.POST;
          });
        };
        this.getOne = function(object_id, form) {
          return Restangular.one(this.modelName, object_id).get().then(function(obj) {
            obj.saveForm = function(form_name) {
              var form_field, patch_object;
              form_field = form[form_name];
              form_field.isSaving = true;
              patch_object = {};
              patch_object[form_name] = form_field.$viewValue;
              return obj.patch(patch_object).then((function(response) {
                form_field.$setValidity('server', true);
                form_field.isSaving = false;
                return form_field.isSaved = true;
              }), function(response) {
                return _.each(response.data, function(errors, key) {
                  form_field.isSaving = false;
                  form[key].$setValidity('server', false);
                  return form[key].errors = errors;
                });
              });
            };
            return obj;
          });
        };
        this.getList = function() {
          return Restangular.all(this.modelName).getList().$object;
        };
      };
      return {
        Instance: Instance
      };
    }
  ]);

  app.directive("bscField", function() {
    return {
      scope: {
        fieldOptions: "=",
        fieldForm: "="
      },
      templateUrl: "/static/app/partials/field.html",
      transclude: true
    };
  });

}).call(this);
